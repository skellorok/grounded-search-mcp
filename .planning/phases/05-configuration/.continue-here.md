---
phase: 05-configuration
task: post-UAT fixes
total_tasks: N/A (bug fixing session)
status: in_progress
last_updated: 2026-02-04T10:20:00Z
---

<current_state>
Phase 5 UAT completed (7/7 passed), but discovered Antigravity gets 503 capacity errors while OpenCode sometimes succeeds. Investigated OpenCode's implementation to understand differences. Fixed our implementation to match OpenCode's search.js exactly. Currently exploring why OpenCode can succeed when we get 503.
</current_state>

<completed_work>

## Phase 5 UAT
- All 7 tests passed
- Config tool working (--show, --get, --set, --reset)
- Request Details in search responses
- Config persistence working

## Bug Fixes This Session
1. **Antigravity User-Agent format** - Fixed to use full browser string (not short format)
   - Short format `antigravity/1.15.8 linux/amd64` caused 404 errors
   - Now uses full `Mozilla/5.0 ... Antigravity/1.15.8 Chrome/... Electron/... Safari/...`

2. **Static headers for Antigravity search** - Now matches OpenCode's search.js
   - Antigravity: Uses static `ANTIGRAVITY_HEADERS` (not randomized)
   - Gemini CLI: Unchanged (uses existing `getProviderConfig`)

3. **loadCodeAssist headers** - Added `Client-Metadata` header (matches OpenCode's project.js)

4. **Project ID resolution** - Already implemented via loadCodeAssist API

## Investigation This Session
- Checked OpenCode debug logs with `OPENCODE_ANTIGRAVITY_DEBUG=verbose`
- Discovered OpenCode ALSO gets 503 capacity errors
- Key difference: OpenCode has model-driven retry (functionResponse loop)
- Our implementation falls back to Gemini CLI immediately on 503

</completed_work>

<remaining_work>

**Immediate decision needed:**
- Should we add retry logic for 503 before falling back to Gemini CLI?
- OpenCode retries via model (google_search is a function tool, not grounding tool)
- Our architecture uses grounding tool directly - different approach

**Optional improvements:**
- Add 503 retry with backoff before fallback
- Consider if we want to match OpenCode's function tool approach (major refactor)

**Phase 6 (Polish):**
- Not started yet
- Waiting for Antigravity capacity issues to be resolved/understood

</remaining_work>

<decisions_made>

**This session:**
- Use static `ANTIGRAVITY_HEADERS` for Antigravity search (matches OpenCode's search.js)
- Keep `getProviderConfig` for Gemini CLI (different API, was working)
- Don't change Gemini CLI implementation when fixing Antigravity bugs
- Added `Client-Metadata` to loadCodeAssist headers (matches OpenCode's project.js)

**Architecture difference identified:**
- OpenCode: `google_search` is a function tool → model can retry on error
- Us: `googleSearch` is a grounding tool → we control retry logic
- Both get 503 errors, but OpenCode's model retries automatically

</decisions_made>

<blockers>

**Active:**
- Antigravity 503 "No capacity available for model gemini-3-flash"
- Capacity fluctuates - OpenCode sometimes succeeds, sometimes fails
- Our fallback to Gemini CLI works, so not blocking functionality

**Not blocking:**
- Gemini CLI fallback works perfectly with full grounding
- Users can still search, just via fallback provider

</blockers>

<context>

**Key insight from OpenCode logs:**
OpenCode's `google_search` is exposed as a function tool to the model. When search returns 503, the error is passed back to the model as a `functionResponse`. The model then decides to retry with a different query. This is model-driven retry, not explicit retry logic.

Our approach uses the `googleSearch` grounding tool directly in the API request. When we get 503, we fall back to Gemini CLI. We don't have model-driven retry because the model doesn't see the error.

**Files committed this session:**
- `fix(api): resolve Antigravity project ID via loadCodeAssist` (12409dc)
- `docs(05): Phase 5 UAT complete - 7/7 tests passed` (52b02ac)
- `fix(search): use static headers for Antigravity like OpenCode's search.js` (6d9413a)

**OpenCode debug commands:**
```bash
export OPENCODE_ANTIGRAVITY_DEBUG=verbose
export OPENCODE_ANTIGRAVITY_CONSOLE_LOG=1
opencode
```
Logs at: `~/.config/opencode/antigravity-logs/`

</context>

<next_action>

**When resuming:**

1. Decide: Add 503 retry logic or keep immediate fallback?
   - Option A: Add retry with exponential backoff (1-2 attempts) before fallback
   - Option B: Keep current behavior (immediate fallback to Gemini CLI)

2. If adding retry: Implement in `tryAntigravitySearch` function

3. Test when Antigravity has capacity to verify grounding works

4. Continue to Phase 6 (Polish) when ready

**Test command:**
```
grounded_search query="What is the weather in Tokyo?"
```

If returns Provider: Antigravity → capacity available, grounding should work
If returns Provider: Gemini CLI with "Fallback provider used" → still at capacity

</next_action>
