---
phase: 04-core-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/constants.ts
  - src/api/request.ts
  - src/api/index.ts
autonomous: true

must_haves:
  truths:
    - "API requests can be built with correct provider-specific endpoints and headers"
    - "Two-stage orchestration payload structure forces grounding (googleSearch tool only)"
    - "Request ID and session ID are generated per-request"
  artifacts:
    - path: "src/api/constants.ts"
      provides: "Endpoints, headers, model defaults, system instruction"
      exports: ["GEMINI_CLI_CONFIG", "ANTIGRAVITY_CONFIG", "DEFAULT_MODEL", "DEFAULT_THINKING_LEVEL", "SEARCH_SYSTEM_INSTRUCTION", "ANTIGRAVITY_VERSION", "generateRequestId", "generateSessionId", "getRandomizedHeaders"]
    - path: "src/api/request.ts"
      provides: "Request building with two-stage orchestration"
      exports: ["buildSearchRequest", "wrapProviderRequest", "getProviderConfig"]
    - path: "src/api/index.ts"
      provides: "Re-exports for API module"
      exports: ["buildSearchRequest", "wrapProviderRequest", "getProviderConfig"]
  key_links:
    - from: "src/api/request.ts"
      to: "src/api/constants.ts"
      via: "import"
      pattern: "import.*from.*constants"
---

<objective>
Create API client infrastructure with provider-specific configurations and two-stage orchestration request building.

Purpose: This plan establishes the foundation for making actual API calls to both Gemini CLI and Antigravity providers. The two-stage orchestration pattern ensures search grounding occurs (model cannot skip search).

Output: Working request building that produces correct API payloads for both providers.
</objective>

<execution_context>
@/home/skello/.claude/get-shit-done/workflows/execute-plan.md
@/home/skello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-search/04-CONTEXT.md
@.planning/phases/04-core-search/04-RESEARCH.md

# Source code references
@src/auth/providers.ts (provider configs for reference)
@src/auth/types.ts (ProviderName type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API constants module</name>
  <files>src/api/constants.ts</files>
  <action>
Create `src/api/constants.ts` with provider configurations and utility functions.

Include:
1. **Endpoint configs** - Gemini CLI uses `cloudcode-pa.googleapis.com`, Antigravity uses `daily-cloudcode-pa.sandbox.googleapis.com`
2. **Header configs** - Gemini CLI uses simple Google API headers, Antigravity uses randomized headers from OpenCode pattern
3. **Default model** - `gemini-3-flash` (per CONTEXT.md)
4. **Default thinking** - `thinkingLevel: "low"`, `includeThoughts: false` (per CONTEXT.md)
5. **System instruction** - Port from OpenCode: instruction that tells model to use web search for current information
6. **Request ID generation** - Pattern: `${prefix}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`
7. **Session ID generation** - Simple counter + prefix pattern
8. **Antigravity version** - `1.15.8` (critical for User-Agent)
9. **getRandomizedHeaders()** - Rotates User-Agent components for Antigravity rate limit avoidance

Reference OpenCode patterns from RESEARCH.md:
- `~/.cache/opencode/node_modules/opencode-antigravity-auth/dist/src/constants.js` for headers/endpoints
- Use `ANTIGRAVITY_VERSION = "1.15.8"` in User-Agent

Export all constants and utility functions.
  </action>
  <verify>
`npm run build` compiles without errors. Inspect output to confirm constants are exported.
  </verify>
  <done>
Constants module exports: GEMINI_CLI_CONFIG, ANTIGRAVITY_CONFIG, DEFAULT_MODEL, DEFAULT_THINKING_LEVEL, SEARCH_SYSTEM_INSTRUCTION, ANTIGRAVITY_VERSION, generateRequestId, generateSessionId, getRandomizedHeaders.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create request building module</name>
  <files>src/api/request.ts</files>
  <action>
Create `src/api/request.ts` with two-stage orchestration request building.

Implement:
1. **SearchRequestOptions interface** - query, thinkingLevel?, includeThoughts?
2. **buildSearchPayload()** - Internal function that creates the core request payload:
   - `systemInstruction.parts[].text` = SEARCH_SYSTEM_INSTRUCTION
   - `contents[].role = "user"`, `contents[].parts[].text = query`
   - `tools = [{ googleSearch: {} }]` - ONLY grounding tool, NO function declarations
   - `generationConfig.thinkingConfig` with thinkingLevel and includeThoughts
3. **wrapProviderRequest()** - Wraps payload for specific provider:
   - Antigravity: wraps in `{ project, model, userAgent, requestId, request: { ...payload, sessionId } }`
   - Gemini CLI: uses payload directly (no wrapping needed)
4. **buildSearchRequest()** - Main entry point combining payload + wrapping
5. **getProviderConfig()** - Returns endpoint and headers for provider

Import constants from `./constants.ts`. Import ProviderName from `../auth/types.js`.

The two-stage pattern is CRITICAL: by including ONLY `{ googleSearch: {} }` in tools, we force the model to search. If function declarations were mixed in, the model might skip search.
  </action>
  <verify>
`npm run build` compiles without errors. Inspect output to confirm functions are exported.
  </verify>
  <done>
Request module exports: buildSearchRequest, wrapProviderRequest, getProviderConfig. Payloads include `tools: [{ googleSearch: {} }]` for forced grounding.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update API module index</name>
  <files>src/api/index.ts</files>
  <action>
Update `src/api/index.ts` to:
1. Remove the placeholder mock `search()` function
2. Re-export from `./constants.js`: constants and utility functions
3. Re-export from `./request.js`: buildSearchRequest, wrapProviderRequest, getProviderConfig

Keep the file as a clean barrel export. The actual search execution will be added in Plan 04-02.

Update SearchOptions interface if needed, or remove if no longer used.
  </action>
  <verify>
`npm run build` compiles without errors. `npm run lint` passes.
  </verify>
  <done>
API index cleanly re-exports constants and request functions. No mock implementation remains.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm run lint` passes
3. Inspect `build/api/constants.js` - confirms endpoint URLs and headers are correct
4. Inspect `build/api/request.js` - confirms `tools: [{ googleSearch: {} }]` in payload
</verification>

<success_criteria>
- Constants module provides all provider-specific configurations
- Request building produces correct two-stage orchestration payloads
- No runtime errors when importing API module
- Code follows established project patterns (TypeScript strict, ESLint clean)
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-search/04-01-SUMMARY.md`
</output>
