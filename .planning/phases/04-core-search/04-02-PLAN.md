---
phase: 04-core-search
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/api/response.ts
  - src/api/search.ts
  - src/api/index.ts
  - src/tools/search.ts
autonomous: true

must_haves:
  truths:
    - "Search tool performs actual Google-grounded search via Gemini API"
    - "Search results include source citations with titles and URLs"
    - "Search results include the queries Google actually used"
    - "Response is formatted as markdown with Search Results, Sources, and Search Queries Used sections"
  artifacts:
    - path: "src/api/response.ts"
      provides: "Response parsing and markdown formatting"
      exports: ["parseSearchResponse", "formatSearchResult", "SearchResult", "Source"]
    - path: "src/api/search.ts"
      provides: "Main search execution with fallback"
      exports: ["executeGroundedSearch", "searchWithFallback"]
    - path: "src/tools/search.ts"
      provides: "MCP tool calling real API"
      contains: "executeGroundedSearch"
  key_links:
    - from: "src/tools/search.ts"
      to: "src/api/search.ts"
      via: "import executeGroundedSearch"
      pattern: "import.*executeGroundedSearch.*from"
    - from: "src/api/search.ts"
      to: "src/api/request.ts"
      via: "import buildSearchRequest"
      pattern: "import.*buildSearchRequest.*from"
    - from: "src/api/search.ts"
      to: "src/api/response.ts"
      via: "import parseSearchResponse"
      pattern: "import.*parseSearchResponse.*from"
---

<objective>
Implement response parsing, search execution, and update the MCP tool to perform real Google-grounded searches.

Purpose: This plan completes Phase 4 by connecting the MCP tool to the actual Gemini API, parsing grounding metadata from responses, and formatting results as markdown for GSD agent consumption.

Output: Working `grounded_search` tool that returns real search results with citations and query transparency.
</objective>

<execution_context>
@/home/skello/.claude/get-shit-done/workflows/execute-plan.md
@/home/skello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-search/04-CONTEXT.md
@.planning/phases/04-core-search/04-RESEARCH.md
@.planning/phases/04-core-search/04-01-SUMMARY.md

# Source code references
@src/api/constants.ts (from Plan 04-01)
@src/api/request.ts (from Plan 04-01)
@src/auth/index.ts (getValidAccessToken, ProviderName)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create response parsing module</name>
  <files>src/api/response.ts</files>
  <action>
Create `src/api/response.ts` with response parsing and markdown formatting.

Implement:
1. **Types**:
   - `Source { title: string; url: string }`
   - `SearchResult { text: string; sources: Source[]; searchQueries: string[] }`
   - `ApiResponse` type for the raw API response structure

2. **parseSearchResponse(data: ApiResponse): SearchResult**:
   - Extract text from `response.candidates[0].content.parts[].text`
   - Extract sources from `response.candidates[0].groundingMetadata.groundingChunks[].web` (title, uri)
   - Extract search queries from `response.candidates[0].groundingMetadata.webSearchQueries`
   - Handle missing/undefined gracefully (return empty arrays/strings)
   - Deduplicate sources by URL

3. **formatSearchResult(result: SearchResult): string**:
   - Format as markdown per CONTEXT.md:
   ```
   ## Search Results

   {result.text}

   ### Sources
   - [Title](url) (domain.com)
   ...

   ### Search Queries Used
   - "query 1"
   - "query 2"
   ```
   - Extract domain from URL using `new URL(url).hostname`
   - Skip Sources section if empty
   - Skip Search Queries Used section if empty

4. **formatErrorResponse(status: number, errorText: string, provider: ProviderName): string**:
   - 401/403: Authentication error with re-auth instructions
   - 429: Rate limited with guidance
   - Other: Generic error with troubleshooting tips
   - NO auto-triggered auth flow (per CONTEXT.md)
  </action>
  <verify>
`npm run build` compiles without errors. Inspect output to confirm exports.
  </verify>
  <done>
Response module exports: parseSearchResponse, formatSearchResult, formatErrorResponse, SearchResult, Source types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create search execution module</name>
  <files>src/api/search.ts</files>
  <action>
Create `src/api/search.ts` with main search execution logic.

Implement:
1. **SearchOptions interface** - thinkingLevel?, includeThoughts?

2. **executeGroundedSearch(query, provider, accessToken, options?): Promise<string>**:
   - Get provider config via `getProviderConfig(provider)`
   - Build request via `buildSearchRequest(query, provider, options)`
   - Make fetch call to `${config.endpoint}/v1internal:generateContent`
   - Headers: `Authorization: Bearer ${accessToken}`, `Content-Type: application/json`, plus provider headers
   - Add timeout via `AbortSignal.timeout(30000)` (30 seconds)
   - On success: parse with `parseSearchResponse()`, format with `formatSearchResult()`
   - On error: format with `formatErrorResponse()`

3. **searchWithFallback(query, options?): Promise<string>**:
   - Get default provider via auth module
   - Try default provider first
   - If fails and other provider is configured, try that
   - If both fail, return "No Providers Available" message
   - Uses `getValidAccessToken()` from auth module (handles refresh)

Import from:
- `./constants.js` - constants
- `./request.js` - buildSearchRequest, getProviderConfig
- `./response.js` - parseSearchResponse, formatSearchResult, formatErrorResponse
- `../auth/index.js` - getValidAccessToken, getDefaultProvider, isAuthenticated, ProviderName
  </action>
  <verify>
`npm run build` compiles without errors.
  </verify>
  <done>
Search module exports: executeGroundedSearch, searchWithFallback. Handles provider fallback and error formatting.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update search tool to use real API</name>
  <files>src/tools/search.ts, src/api/index.ts</files>
  <action>
Update `src/tools/search.ts` to call the real API:

1. Import `searchWithFallback` from `../api/index.js`

2. Replace the mock response logic with:
   ```typescript
   const result = await searchWithFallback(args.query, {
     thinkingLevel: args.thinking_level === 'none' ? undefined : args.thinking_level,
     includeThoughts: false
   });

   return {
     content: [{ type: 'text', text: result }],
     isError: result.startsWith('## Authentication') || result.startsWith('## Search Error') || result.startsWith('## Rate Limited') || result.startsWith('## No Providers')
   };
   ```

3. Keep the existing auth check at the top (for early fail with clear message)

4. Update tool schema if needed:
   - Keep `query` (required)
   - Keep `model` (optional, for Phase 5)
   - Keep `thinking_level` (optional, default 'low' per CONTEXT.md)

Update `src/api/index.ts` to re-export from `./search.js` and `./response.js`:
- `searchWithFallback`, `executeGroundedSearch`
- `parseSearchResponse`, `formatSearchResult`, `formatErrorResponse`
  </action>
  <verify>
`npm run build` succeeds. `npm run lint` passes.

Manual test (requires auth):
1. Run MCP server
2. Call grounded_search with a current events query like "latest news today"
3. Verify response has:
   - `## Search Results` with actual content
   - `### Sources` with linked citations
   - `### Search Queries Used` with quoted queries
  </verify>
  <done>
grounded_search tool calls real Gemini API. Returns markdown-formatted results with sources and search queries.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm run lint` passes
3. `npm run test` passes (if tests exist)
4. Manual verification:
   - Start MCP server
   - Authenticate with a provider
   - Call grounded_search with query "Claude Code latest features 2026"
   - Response includes real search results, not mock
   - Response has Sources section with actual URLs
   - Response has Search Queries Used section
</verification>

<success_criteria>
- grounded_search performs actual Google-grounded search (SEARCH-01)
- Results include source citations with URLs and titles (SEARCH-02)
- Results include search queries used for transparency (SEARCH-03)
- Two-stage orchestration guarantees grounding occurs
- Error responses are informative without auto-triggering auth flows
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-search/04-02-SUMMARY.md`
</output>
