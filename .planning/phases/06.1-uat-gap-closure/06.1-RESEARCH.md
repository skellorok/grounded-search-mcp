# Phase 6.1: UAT Gap Closure & DX Tooling - Research

**Researched:** 2026-02-05
**Domain:** MCP server enhancement, Claude Code slash commands, project rename
**Confidence:** HIGH (verified against official Claude Code documentation)

## Summary

This phase addresses four UAT gaps discovered during Phase 6 validation: fallback reason transparency, expanded error fallback triggers, project rename from gemini-search-mcp to grounded-search-mcp, and GSD integration documentation/tooling.

The research validates two critical questions from CONTEXT.md:
1. **Agent override verification:** Project-level agents (`.claude/agents/`) DO override user-level agents (`~/.claude/agents/`) when they share the same name. This is confirmed by official Claude Code documentation which specifies a priority hierarchy where project-level (priority 2) takes precedence over user-level (priority 3).
2. **GSD instruction placement:** Instructions should go in the agent's system prompt body (markdown content after frontmatter), not in PROJECT.md or CONTEXT.md. The tool list in frontmatter controls access; the body provides behavioral guidance.

**Primary recommendation:** Implement in order: code fixes first (smallest scope, testable), then project rename (affects all artifacts), then slash commands and docs (build on renamed foundation).

## Standard Stack

This phase requires no new dependencies. All work uses existing project infrastructure.

### Core (No Changes)
| Library | Version | Purpose | Already Present |
|---------|---------|---------|-----------------|
| @modelcontextprotocol/sdk | ^1.25.3 | MCP server framework | Yes |
| env-paths | ^4.0.0 | XDG-compliant config paths | Yes |
| zod | ^3.25.30 | Schema validation | Yes |

### Supporting (No Changes)
No additional libraries needed.

### Alternatives Considered
| Instead of | Could Use | Decision |
|------------|-----------|----------|
| Custom skill system | Claude Code native skills | Use native skills for slash commands |
| npm link for rename | Direct file rename + npm publish | Direct rename, npm publish on release |

## Architecture Patterns

### Pattern 1: Fallback Error Surfacing

**What:** Surface fallback reason in response metadata without adding warning at top of response.

**Implementation location:** `src/api/search.ts` in `searchWithFallback()` and `addMetadataToResult()`

**Current state:**
```typescript
// Line 468-484 in search.ts
function addMetadataToResult(
  searchResult: SearchResultWithMetadata,
  fallbackUsed: boolean,  // Only tracks IF fallback was used
): string {
  // ...
  if (metadata.fallbackUsed) {
    lines.push('- **Note:** Fallback provider used');  // No reason
  }
```

**Required change:**
```typescript
// Add fallbackReason to RequestMetadata type in response.ts
export interface RequestMetadata {
  provider: ProviderName;
  model: string;
  responseTime?: number;
  fallbackUsed?: boolean;
  fallbackReason?: string;  // NEW: e.g., "429 (rate limited)"
  thinkingLevel?: 'high' | 'low' | 'none';
}

// In search.ts addMetadataToResult():
function addMetadataToResult(
  searchResult: SearchResultWithMetadata,
  fallbackUsed: boolean,
  fallbackReason?: string,  // NEW parameter
): string {
  // ...
  if (metadata.fallbackUsed && fallbackReason) {
    lines.push(`- **Fallback:** ${fallbackReason}`);  // Shows reason
  } else if (metadata.fallbackUsed) {
    lines.push('- **Note:** Fallback provider used');
  }
```

**Source:** CONTEXT.md decision: "Fallback reason exposed in response metadata only (not warning at top)" with "Code + short message, e.g., 'Fallback: 429 (rate limited)'"

### Pattern 2: Expanded Fallback Triggers

**What:** Trigger fallback for any non-success response, not just auth errors.

**Current state (src/api/search.ts lines 615-621):**
```typescript
// Check if result is an auth error that should trigger fallback
if (searchResult.result.startsWith('## Authentication Error')) {
  lastError = searchResult.result;
  continue;  // Try next provider
}

return addMetadataToResult(searchResult, fallbackUsed);  // Returns immediately for other errors
```

**Required change:**
```typescript
// Check if result is any error that should trigger fallback
if (!searchResult.success) {
  // Extract reason from error heading (e.g., "Rate Limited", "Search Error", "Network Error")
  const reasonMatch = searchResult.result.match(/^## (.+?)[\n\r]/);
  lastError = searchResult.result;
  lastErrorReason = reasonMatch ? reasonMatch[1] : 'Unknown error';
  continue;  // Try next provider
}

return addMetadataToResult(searchResult, fallbackUsed, fallbackUsed ? lastErrorReason : undefined);
```

**Key insight:** The `SearchResultWithMetadata` type already has a `success: boolean` field. Use this instead of string matching on error headings.

### Pattern 3: Claude Code Slash Commands (Skills)

**What:** Implement `/grounded-search:query` and `/grounded-search:prep-gsd` as Claude Code skills.

**Skill location:** `.claude/skills/grounded-search/` directory

**Structure:**
```
.claude/skills/grounded-search/
  query.md           # /grounded-search:query skill
  prep-gsd.md        # /grounded-search:prep-gsd skill
```

**Skill file format (from Claude Code docs):**
```markdown
---
name: grounded-search:query
description: Save grounded search results to a file
---

[Skill instructions in markdown]
```

**Source:** [Claude Code Skills Documentation](https://code.claude.com/docs/en/skills)

### Pattern 4: Project Agent Override

**What:** Use project-level `.claude/agents/` directory to override global GSD agents.

**Priority hierarchy (from official docs):**
| Location | Scope | Priority |
|----------|-------|----------|
| `--agents` CLI flag | Current session | 1 (highest) |
| `.claude/agents/` | Current project | 2 |
| `~/.claude/agents/` | All projects | 3 |
| Plugin agents | Where enabled | 4 (lowest) |

**Override behavior:** When multiple agents share the same name, higher-priority location wins. Project-level agents with the same name as user-level agents will override them.

**prep-gsd implementation approach:**
1. Check if `.claude/agents/` exists at project level
2. For each target agent (gsd-phase-researcher, gsd-project-researcher):
   - Check if project-level agent exists
   - If not, copy from `~/.claude/agents/` to `.claude/agents/`
   - Modify tool list to add `mcp__grounded-search__*`
   - Add preference instruction to body
3. Check `.mcp.json` for grounded-search configuration
4. Present checklist of changes, wait for confirmation

**Source:** [Claude Code Sub-agents Documentation](https://code.claude.com/docs/en/sub-agents)

### Pattern 5: Config Path Rename

**What:** Rename config storage from `google-search-mcp` to `grounded-search-mcp`.

**Current state (src/auth/token-storage.ts line 24):**
```typescript
const paths = envPaths('google-search-mcp', { suffix: '' });
```

**Required change:**
```typescript
const paths = envPaths('grounded-search-mcp', { suffix: '' });
```

**Migration behavior (per CONTEXT.md: Claude's discretion):**
- Do NOT auto-migrate tokens from old path
- User will need to re-authenticate after rename
- Old tokens remain in old location (not deleted)
- No migration warning needed (clean slate approach)

### Anti-Patterns to Avoid

- **String matching for error detection:** Use `success: boolean` field, not regex on error text
- **Modifying global GSD agents:** Always use project-level overrides
- **Auto-migrating config:** Requires re-auth after rename (simpler, cleaner)

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Slash commands | Custom MCP prompts | Claude Code skills | Native integration, auto-discovery |
| Agent override | Custom merge logic | Same-name override | Claude Code handles resolution |
| Query slug generation | Complex regex | Simple sanitization | `query.slice(0,30).toLowerCase().replace(/[^a-z0-9]+/g, '-')` |
| Timestamp formatting | Custom date logic | Date.toISOString() + slice | Standard, reliable |

## Common Pitfalls

### Pitfall 1: Assuming WebSearch Fallback is MCP Tool
**What goes wrong:** Trying to invoke WebSearch as an MCP tool when both grounded providers fail.
**Why it happens:** WebSearch is a Claude built-in tool, not an MCP tool.
**How to avoid:** Return a structured response that instructs Claude to use WebSearch, don't try to call it programmatically.
**Implementation:**
```typescript
// When both providers fail:
return `## Both Grounded Providers Failed

**Antigravity error:** ${antigravityError}
**Gemini CLI error:** ${geminiError}

Please use Claude's built-in WebSearch tool for this query as a fallback.`;
```

### Pitfall 2: Agent Tool List Format
**What goes wrong:** Incorrect tool names in agent frontmatter.
**Why it happens:** MCP tool naming convention is specific: `mcp__<server-key>__<tool-name>`.
**How to avoid:** After rename, tool names become `mcp__grounded-search__grounded_search`, `mcp__grounded-search__auth`, `mcp__grounded-search__config`.
**Warning signs:** "Tool not found" errors in agent execution.

### Pitfall 3: Config Path Platform Differences
**What goes wrong:** Hardcoding Linux paths, breaking on macOS/Windows.
**Why it happens:** Forgetting env-paths handles platform differences.
**How to avoid:** Always use `envPaths('grounded-search-mcp', { suffix: '' })`, never hardcode paths.
**Locations by platform:**
- Linux: `~/.config/grounded-search-mcp/`
- macOS: `~/Library/Application Support/grounded-search-mcp/`
- Windows: `%APPDATA%\grounded-search-mcp\`

### Pitfall 4: Skill vs Agent Confusion
**What goes wrong:** Creating a skill when an agent is needed (or vice versa).
**Why it happens:** Skills run in main conversation context, agents run in isolated context.
**Correct choice for this phase:**
- `/grounded-search:query`: **Skill** - needs main conversation context to run search
- `/grounded-search:prep-gsd`: **Skill** - needs to read/write files in main context

## Code Examples

### Example 1: Extracting Fallback Reason from Error

```typescript
// Source: Custom implementation for this project
function extractFallbackReason(errorResult: string): string {
  // Match error heading: "## Rate Limited", "## Search Error", etc.
  const headingMatch = errorResult.match(/^## (.+?)[\n\r]/);
  if (!headingMatch) return 'Unknown error';

  const heading = headingMatch[1];

  // Extract status code if present
  const statusMatch = errorResult.match(/\*\*Status:\*\* (\d+)/);
  const status = statusMatch ? statusMatch[1] : null;

  // Format: "429 (rate limited)" or just "Rate Limited"
  if (status) {
    return `${status} (${heading.toLowerCase()})`;
  }
  return heading;
}
```

### Example 2: Skill File for /grounded-search:query

```markdown
---
name: grounded-search:query
description: Perform a grounded search and save results to a file
---

# Grounded Search Query

Perform a Google-grounded search and save the results to a markdown file.

## Usage

/grounded-search:query "your search terms here"

## Behavior

1. **Validate input:** Query argument is required. Fail with message if missing.

2. **Execute search:** Call `mcp__grounded-search__grounded_search` with the query.

3. **Generate filename:**
   - Directory: `./grounded-search-results/`
   - Format: `YYYY-MM-DD-HH-MM-{slug}.md`
   - Slug: First 30 chars of query, lowercase, non-alphanumeric replaced with hyphens

4. **Write file:** Save full search response to the generated filename.

5. **Report:** Show the filename and a brief summary of results.

## Example

```
/grounded-search:query "TypeScript 5.8 features"
```

Creates: `./grounded-search-results/2026-02-05-14-30-typescript-5-8-features.md`
```

### Example 3: Skill File for /grounded-search:prep-gsd

```markdown
---
name: grounded-search:prep-gsd
description: Prepare GSD agents for grounded search integration
---

# Prepare GSD for Grounded Search

Check and configure GSD integration with grounded search.

## Behavior

1. **Check current state** (idempotent):
   - Does `.claude/agents/` exist at project level?
   - Are gsd-phase-researcher and gsd-project-researcher present?
   - Do they have grounded-search in tool list?
   - Is `.mcp.json` configured with grounded-search?

2. **Present checklist** of needed changes:
   ```
   [ ] Create .claude/agents/ directory
   [ ] Copy gsd-phase-researcher.md from ~/.claude/agents/
   [ ] Add mcp__grounded-search__* to tool list
   [ ] Add grounded_search preference instruction
   [ ] Same for gsd-project-researcher.md
   [ ] Add grounded-search to .mcp.json (if missing)
   ```

3. **Wait for confirmation** before making changes.

4. **Apply changes** for confirmed items.

5. **Ask about commit** after changes applied.

## Agent Modification

Add to tool list in frontmatter:
```yaml
tools: Read, Write, Bash, Grep, Glob, WebSearch, WebFetch, mcp__context7__*, mcp__grounded-search__*
```

Add to agent body (after existing content):
```markdown
## Web Research Tool Preference

For web research tasks, prefer `mcp__grounded-search__grounded_search` over `WebSearch`:
- Better search quality via Google's index
- Query transparency shows actual searches performed
- Fall back to WebSearch if grounded_search is unavailable or fails
```
```

### Example 4: Project Rename Checklist

```typescript
// Files requiring name changes for "grounded-search-mcp" rename:

// 1. package.json
{
  "name": "grounded-search-mcp",  // was: gemini-search-mcp
  "bin": {
    "grounded-search-mcp": "./build/index.js"  // was: gemini-search-mcp
  }
}

// 2. src/auth/token-storage.ts (line 24)
const paths = envPaths('grounded-search-mcp', { suffix: '' });
// was: envPaths('google-search-mcp', { suffix: '' })

// 3. README.md - update all references
// 4. docs/gsd-integration.md - update tool names
// 5. LICENSE - update copyright line
// 6. .mcp.json examples - update server key to "grounded-search"
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Auth-only fallback trigger | Any-error fallback | Phase 6.1 | More resilient search |
| Hidden fallback | Fallback reason exposed | Phase 6.1 | Better debugging |
| Custom agent docs | Native skill commands | Phase 6.1 | Better DX |
| gemini-search naming | grounded-search naming | Phase 6.1 | Generic, future-proof |

## Open Questions

### 1. GitHub Repo Rename
**What we know:** CONTEXT.md specifies GitHub repo should be renamed to grounded-search-mcp.
**What's unclear:** Timing relative to npm publish, redirect handling.
**Recommendation:** Rename after npm publish but before announcement. GitHub provides automatic redirects.

### 2. Skills Location
**What we know:** Skills can be in `.claude/skills/` at project level.
**What's unclear:** Whether skills should be packaged with npm or remain project-specific.
**Recommendation:** Document as project-level setup, not npm-packaged. Users copy skills to their projects.

### 3. WebSearch Fallback Format
**What we know:** When both grounded providers fail, should fall back to WebSearch.
**What's unclear:** Exact response format to trigger Claude's WebSearch.
**Recommendation:** Return informative error message instructing Claude to use WebSearch. Don't try to invoke programmatically.

## Sources

### Primary (HIGH confidence)
- [Claude Code Sub-agents Documentation](https://code.claude.com/docs/en/sub-agents) - Agent override priority, tool lists
- [Claude Code Skills Documentation](https://code.claude.com/docs/en/skills) - Skill format and behavior
- Project source code: `src/api/search.ts`, `src/api/response.ts`, `src/auth/token-storage.ts`

### Secondary (MEDIUM confidence)
- [GitHub Issue #10012](https://github.com/anthropics/claude-code/issues/10012) - Agent override bug (doesn't affect our use case)
- CONTEXT.md decisions - Locked implementation choices

### Tertiary (LOW confidence)
- None - all findings verified against official sources

## Metadata

**Confidence breakdown:**
- Code fixes (Gap 6, 7): HIGH - Direct code inspection, clear implementation path
- Project rename (Gap 2): HIGH - Straightforward file changes, well-understood scope
- Slash commands (Gap 4): HIGH - Official Claude Code docs, standard patterns
- GSD integration: HIGH - Agent override verified against official docs

**Research date:** 2026-02-05
**Valid until:** 2026-03-05 (30 days - stable patterns, official docs)
