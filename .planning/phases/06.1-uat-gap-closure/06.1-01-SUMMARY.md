---
phase: 06.1-uat-gap-closure
plan: 01
subsystem: api
tags: [fallback, error-handling, metadata, search]

# Dependency graph
requires:
  - phase: 04-core-search
    provides: searchWithFallback function, error response formatting
provides:
  - Fallback reason tracking in RequestMetadata
  - Expanded fallback triggers (any error, not just auth)
  - WebSearch suggestion when both providers fail
affects: [06.1-02, 06.1-03]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "extractFallbackReason() for parsing error details"
    - "Fallback reason surfaced in Request Details section"

key-files:
  created: []
  modified:
    - src/api/response.ts
    - src/api/search.ts

key-decisions:
  - "Display fallback reason as '- **Fallback:** {reason}' instead of generic note"
  - "Extract reason from status codes (429, 503, etc) and error headings"
  - "Trigger fallback on any !searchResult.success, not just auth errors"
  - "Append WebSearch tip when both providers fail"

patterns-established:
  - "extractFallbackReason: Parse markdown error responses for reason extraction"

# Metrics
duration: 4min
completed: 2026-02-05
---

# Phase 6.1 Plan 01: Fallback Reason Tracking Summary

**Expanded fallback triggers to any error with reason tracking and WebSearch suggestion for complete failures**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-05T09:57:00Z
- **Completed:** 2026-02-05T10:01:07Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Added `fallbackReason?: string` field to RequestMetadata interface
- Created `extractFallbackReason()` helper to parse status codes and error headings
- Changed fallback trigger from auth-only to any error (`!searchResult.success`)
- Added WebSearch suggestion when both providers fail

## Task Commits

Each task was committed atomically:

1. **Task 1: Add fallbackReason to RequestMetadata type** - `e3d4ee0` (feat)
2. **Task 2: Expand fallback triggers and track reason** - `e11b65f` (feat)

## Files Created/Modified
- `src/api/response.ts` - Added fallbackReason field and updated formatRequestDetails()
- `src/api/search.ts` - Added extractFallbackReason(), updated searchWithFallback() logic

## Decisions Made

1. **Fallback reason display format**: Show `- **Fallback:** {reason}` (e.g., "429 (rate limited)") instead of generic "Fallback provider used" when reason is available. Keeps generic as fallback if reason undefined.

2. **Reason extraction strategy**: Parse status codes from `**Status:** {code}` pattern and map to human-readable descriptions. Fall back to error heading for non-HTTP errors (timeout, network, capacity).

3. **WebSearch tip placement**: Append after the error message with separator (`---`) when both providers fail, giving users an actionable alternative.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Fallback behavior now surfaces specific error reasons
- Ready for project rename (06.1-02) and GSD integration (06.1-03)
- WebSearch suggestion provides graceful degradation path

---
*Phase: 06.1-uat-gap-closure*
*Completed: 2026-02-05*
