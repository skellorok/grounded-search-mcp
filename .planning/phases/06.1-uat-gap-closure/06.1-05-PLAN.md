---
phase: 06.1-uat-gap-closure
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/url-resolver.ts
  - src/api/response.ts
  - src/api/search.ts
  - tests/api/url-resolver.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Source URLs are actual destination URLs (wikipedia.org, etc.), not Google redirects"
    - "WebFetch can follow source URLs to retrieve page content"
    - "URL resolution does not significantly impact response time"
  artifacts:
    - path: "src/api/url-resolver.ts"
      provides: "URL resolution via HTTP HEAD requests"
      exports: ["resolveRedirectUrls"]
    - path: "tests/api/url-resolver.test.ts"
      provides: "Unit tests for URL resolution"
      contains: "resolveRedirectUrls"
  key_links:
    - from: "src/api/search.ts"
      to: "src/api/url-resolver.ts"
      via: "resolveRedirectUrls call after parseSearchResponse"
      pattern: "resolveRedirectUrls"
---

<objective>
Resolve Google redirect URLs to actual destination URLs for source citations.

Purpose: The Gemini API returns redirect URLs (vertexaisearch.cloud.google.com/grounding-api-redirect/...) instead of actual destination URLs. This breaks WebFetch follow-up which is critical for GSD research agents. This plan adds a URL resolution layer using HTTP HEAD requests.

Output: Source citations display actual URLs (wikipedia.org, accuweather.com) that WebFetch can retrieve.
</objective>

<execution_context>
@/home/skello/.claude/get-shit-done/workflows/execute-plan.md
@/home/skello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/source-urls-google-redirect.md

# Existing implementation
@src/api/response.ts
@src/api/search.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create URL resolution module</name>
  <files>src/api/url-resolver.ts, tests/api/url-resolver.test.ts</files>
  <action>
Create src/api/url-resolver.ts with:

1. `resolveRedirectUrl(redirectUrl: string): Promise<string>` function:
   - Make HTTP HEAD request to the redirect URL
   - Follow redirects (fetch follows by default, but use `redirect: 'follow'`)
   - Return the final URL from response.url
   - Timeout: 5 seconds per URL (don't hold up response for slow redirects)
   - On error/timeout: return original URL (graceful degradation)

2. `resolveRedirectUrls(sources: Source[]): Promise<Source[]>` function:
   - Takes array of Source objects from parseSearchResponse
   - Resolves all URLs in parallel using Promise.all
   - Returns new Source array with resolved URLs
   - Preserve title and other properties

3. Optional: Simple in-memory cache (Map<string, string>):
   - Cache resolved URLs to avoid repeated lookups
   - No TTL needed (URLs don't change during session)
   - Clear on process restart (no persistence needed)

Create tests/api/url-resolver.test.ts:
   - Test redirect resolution (mock fetch)
   - Test timeout handling (returns original URL)
   - Test error handling (returns original URL)
   - Test parallel resolution
   - Test caching behavior
  </action>
  <verify>npm test -- tests/api/url-resolver.test.ts passes</verify>
  <done>URL resolution module exists with tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Integrate URL resolution into search flow</name>
  <files>src/api/search.ts, src/api/response.ts</files>
  <action>
Modify src/api/search.ts:

1. Import resolveRedirectUrls from url-resolver.ts

2. In executeGroundedSearchInternal(), after parseSearchResponse():
   - Call resolveRedirectUrls(searchResult.sources)
   - Replace searchResult.sources with resolved sources
   - Do this BEFORE formatSearchResult() is called

Location in code (around line 332):
```typescript
// Parse and format result
const searchResult = parseSearchResponse(data);

// Resolve redirect URLs to actual destinations
const resolvedSources = await resolveRedirectUrls(searchResult.sources);
searchResult.sources = resolvedSources;

return {
  ...baseResult,
  success: true,
  result: formatSearchResult(searchResult),
  responseTime,
};
```

Note: This adds latency for URL resolution. The 5-second per-URL timeout and parallel execution should keep total added time under 5 seconds worst case. Most redirects resolve in <500ms.

Update response.ts Source type if needed (should not need changes).
  </action>
  <verify>
1. npm run build succeeds
2. npm test passes
3. Manual test: Run a grounded search and verify source URLs are actual destinations (e.g., wikipedia.org not vertexaisearch.cloud.google.com)
  </verify>
  <done>Search results show actual destination URLs in sources that WebFetch can retrieve</done>
</task>

</tasks>

<verification>
1. npm run build - TypeScript compiles
2. npm test - All tests pass including new url-resolver tests
3. Manual verification:
   - Run grounded_search with any query
   - Check Sources section shows real URLs (wikipedia.org, cnn.com, etc.)
   - NOT redirect URLs (vertexaisearch.cloud.google.com/grounding-api-redirect/...)
4. WebFetch test: Copy a source URL and verify it can be fetched
</verification>

<success_criteria>
- Source URLs in search results are actual destination URLs
- Redirect URLs (vertexaisearch.cloud.google.com) no longer appear in output
- URL resolution happens transparently (no user action required)
- Graceful degradation: If resolution fails, original URL is preserved
- Response time increase is acceptable (<5 seconds added worst case)
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-uat-gap-closure/06.1-05-SUMMARY.md`
</output>
